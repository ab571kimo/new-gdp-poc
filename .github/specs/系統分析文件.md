# 系統分析文件 GDP POC 系統

版本：003

## 1. 更新紀錄

| 日期       | API編號      | 說明                                           |
| ---------- | ------------ | ---------------------------------------------- |
| 2025-12-12 | GDP_API_0001 | 依據需求規格書[001]進行建立，新增取得站台選單結構資料 API |
| 2025-12-16 | GDP_API_0002 | 依據需求規格書[003]進行建立，新增批次更新選單與頁面結構 API |
| 2025-12-17 | GDP_API_0001 | 加入使用者權限控制，依據 user_id 過濾授權頁面 |

## 2. API 設計

### 2.1 API 列表

- GDP_API_0001 - GET /api/menu/structure
- GDP_API_0002 - POST /api/menu/structure/batch-update

### 2.2 API 參數說明

#### GDP_API_0001 - GET /api/menu/structure

取得站台選單結構資料，回傳雙層式選單（選單群組 > 頁面）的完整結構。

**Request:**

| 位置 | 參數 | 類型 | 必填 | 說明 |
|---|---:|---:|---:|--- |
| Header | X-Forwarded-Email | String | 是 | 使用者 Email（用於識別使用者身份） |

**Response 200:**

| 欄位 | 類型 | 說明 |
|---|---:|--- |
| menuGroups | Array | 選單群組列表 |
| menuGroups[].menu_id | String | 選單識別碼 |
| menuGroups[].menu_name | String | 選單名稱 |
| menuGroups[].menu_no | Number | 選單排序編號（數字越小越前面） |
| menuGroups[].pages | Array | 該選單群組下的頁面列表 |
| menuGroups[].pages[].page_id | String | 頁面識別碼 |
| menuGroups[].pages[].page_name | String | 頁面名稱 |
| menuGroups[].pages[].page_no | Number | 頁面排序編號（數字越小越前面） |
| menuGroups[].pages[].menu_id | String | 所屬選單識別碼 |
| menuGroups[].pages[].dashboard_id | String | 內嵌頁面識別碼（選填，用於內嵌模式） |
| menuGroups[].pages[].url | String | 頁面網址（選填，用於 URL 導頁模式） |
| menuGroups[].pages[].genie_id | String | Genie識別碼（選填） |

**Response 範例:**

```json
{
  "menuGroups": [
    {
      "menu_id": "menu001",
      "menu_name": "功能選單 A",
      "menu_no": 1,
      "pages": [
        {
          "page_id": "page001",
          "page_name": "內嵌頁面 A1",
          "page_no": 1,
          "menu_id": "menu001",
          "dashboard_id": "dashboard_a1",
          "url": null,
          "genie_id": null
        },
        {
          "page_id": "page002",
          "page_name": "URL導頁 A2",
          "page_no": 2,
          "menu_id": "menu001",
          "dashboard_id": null,
          "url": "https://example.com/page-a2",
          "genie_id": null
        },
        {
          "page_id": "page003",
          "page_name": "內嵌頁面 A3",
          "page_no": 3,
          "menu_id": "menu001",
          "dashboard_id": "dashboard_a3",
          "url": null,
          "genie_id": "genie_a3"
        }
      ]
    },
    {
      "menu_id": "menu002",
      "menu_name": "功能選單 B",
      "menu_no": 2,
      "pages": [
        {
          "page_id": "page004",
          "page_name": "內嵌頁面 B1",
          "page_no": 1,
          "menu_id": "menu002",
          "dashboard_id": "dashboard_b1",
          "url": null,
          "genie_id": null
        },
        {
          "page_id": "page005",
          "page_name": "URL導頁 B2",
          "page_no": 2,
          "menu_id": "menu002",
          "dashboard_id": null,
          "url": "https://example.com/page-b2",
          "genie_id": null
        }
      ]
    }
  ]
}
```

**Response 400:**

| 欄位 | 類型 | 說明 |
|---|---:|--- |
| error | String | 錯誤訊息 |
| errorCode | String | 錯誤代碼 |

**Response 500:**

| 欄位 | 類型 | 說明 |
|---|---:|--- |
| error | String | 錯誤訊息 |
| errorCode | String | 錯誤代碼 |

**資料來源表:** dev_temp.data_engineer.gdp_menu_data, dev_temp.data_engineer.gdp_page_data, dev_temp.data_engineer.gdp_user_page

**業務邏輯說明:**

此 API 從 Request Header 取得使用者識別資訊（X-Forwarded-Email），並依據使用者授權過濾選單結構資料。

查詢邏輯：
1. 從 Request Header 取得 X-Forwarded-Email 作為 user_id
2. 查詢 gdp_user_page 表取得該使用者有授權的所有 page_id 列表
3. 查詢 gdp_menu_data 表取得所有選單群組，依 menu_no 欄位升冪排序
4. 依每個選單的 menu_id 查詢 gdp_page_data 表取得該選單群組下的所有頁面，依 page_no 欄位升冪排序
5. 過濾頁面資料：只保留在使用者授權 page_id 列表中的頁面
6. 過濾選單群組：移除沒有任何頁面的選單群組
7. 組合選單群組與頁面資料，回傳完整的雙層結構
8. 若查詢結果為空，回傳空陣列 `{"menuGroups": []}`

排序邏輯：
- 選單群組按 menu_no 數字由小到大排序（例如：menu_no=1 排在 menu_no=2 前面）
- 每個選單群組內的頁面按 page_no 數字由小到大排序（例如：page_no=1 排在 page_no=2 前面）

頁面顯示模式判斷：
- 若 gdp_page_data 中的 dashboard_id 欄位有值，該頁面為內嵌模式
- 若 gdp_page_data 中的 url 欄位有值（且 dashboard_id 為空），該頁面為 URL 導頁模式
- 若兩者皆有值，優先使用 dashboard_id（內嵌模式）
- 若兩者皆無值，仍回傳該頁面資料，由前端判斷該頁面不可點選

**SQL 查詢語句:**

```sql
-- 查詢使用者有授權的頁面 ID 列表
SELECT page_id
FROM dev_temp.data_engineer.gdp_user_page
WHERE user_id = :user_id;

-- 查詢選單群組資料
SELECT menu_id, menu_name, menu_no
FROM dev_temp.data_engineer.gdp_menu_data
ORDER BY menu_no ASC;

-- 查詢指定選單下的頁面資料（含權限過濾）
SELECT p.page_id, p.page_name, p.page_no, p.menu_id, p.dashboard_id, p.url, p.genie_id
FROM dev_temp.data_engineer.gdp_page_data p
INNER JOIN dev_temp.data_engineer.gdp_user_page up ON p.page_id = up.page_id
WHERE p.menu_id = :menu_id
  AND up.user_id = :user_id
ORDER BY p.page_no ASC;
```

---

### 2.3 API 參數說明

#### GDP_API_0002 - POST /api/menu/structure/batch-update

批次更新選單與頁面結構資料，一次性更新所有選單和頁面的資訊及排序。

**Request:**

| 位置 | 參數 | 類型 | 必填 | 說明 |
|---|---:|---:|---:|--- |
| Body | menuGroups | Array | 是 | 完整的選單群組列表 |
| Body | menuGroups[].menu_id | String | 是 | 選單識別碼 |
| Body | menuGroups[].menu_name | String | 是 | 選單名稱（長度限制 1-50 字元） |
| Body | menuGroups[].menu_no | Number | 是 | 選單排序編號 |
| Body | menuGroups[].pages | Array | 否 | 該選單群組下的頁面列表 |
| Body | menuGroups[].pages[].page_id | String | 是 | 頁面識別碼 |
| Body | menuGroups[].pages[].page_name | String | 是 | 頁面名稱（長度限制 1-50 字元） |
| Body | menuGroups[].pages[].page_no | Number | 是 | 頁面排序編號 |
| Body | menuGroups[].pages[].menu_id | String | 是 | 所屬選單識別碼 |
| Body | menuGroups[].pages[].dashboard_id | String | 否 | 內嵌頁面識別碼 |
| Body | menuGroups[].pages[].url | String | 否 | 頁面網址 |
| Body | menuGroups[].pages[].genie_id | String | 否 | Genie識別碼 |

**Request 範例:**

```json
{
  "menuGroups": [
    {
      "menu_id": "menu001",
      "menu_name": "功能選單 A",
      "menu_no": 1,
      "pages": [
        {
          "page_id": "page001",
          "page_name": "內嵌頁面 A1",
          "page_no": 1,
          "menu_id": "menu001",
          "dashboard_id": "dashboard_a1",
          "url": null,
          "genie_id": null
        },
        {
          "page_id": "page002",
          "page_name": "URL導頁 A2",
          "page_no": 2,
          "menu_id": "menu001",
          "dashboard_id": null,
          "url": "https://example.com/page-a2",
          "genie_id": null
        }
      ]
    },
    {
      "menu_id": "menu002",
      "menu_name": "功能選單 B",
      "menu_no": 2,
      "pages": [
        {
          "page_id": "page003",
          "page_name": "內嵌頁面 B1",
          "page_no": 1,
          "menu_id": "menu002",
          "dashboard_id": "dashboard_b1",
          "url": null,
          "genie_id": "genie_b1"
        }
      ]
    }
  ]
}
```

**Response 200:**

| 欄位 | 類型 | 說明 |
|---|---:|--- |
| success | Boolean | 更新是否成功 |
| message | String | 回應訊息 |

**Response 範例:**

```json
{
  "success": true,
  "message": "選單與頁面結構批次更新成功"
}
```

**Response 400:**

| 欄位 | 類型 | 說明 |
|---|---:|--- |
| success | Boolean | 固定為 false |
| message | String | 錯誤訊息 |
| error | String | 詳細錯誤說明 |

**Response 400 範例:**

```json
{
  "success": false,
  "message": "資料驗證失敗",
  "error": "選單名稱長度必須在 1-50 字元之間"
}
```

**Response 500:**

| 欄位 | 類型 | 說明 |
|---|---:|--- |
| success | Boolean | 固定為 false |
| message | String | 錯誤訊息 |
| error | String | 詳細錯誤說明 |

**Response 500 範例:**

```json
{
  "success": false,
  "message": "系統錯誤",
  "error": "資料庫更新失敗，交易已回滾"
}
```

**資料來源表:** dev_temp.data_engineer.gdp_menu_data, dev_temp.data_engineer.gdp_page_data

**業務邏輯說明:**

此 API 用於批次更新所有選單與頁面的資訊及排序順序。使用 Transaction 確保資料一致性。

更新邏輯：
1. 開啟資料庫交易（Transaction）
2. 驗證所有輸入資料：
   - 選單名稱和頁面名稱長度必須在 1-50 字元之間
   - 必填欄位不可為空
   - menu_no 和 page_no 必須為正整數
3. 更新 gdp_menu_data 表：
   - 依據 menu_id 更新每個選單的 menu_name 和 menu_no
   - 若 menu_id 不存在則插入新記錄
4. 更新 gdp_page_data 表：
   - 依據 page_id 更新每個頁面的 page_name、page_no、menu_id、dashboard_id、url、genie_id
   - 若 page_id 不存在則插入新記錄
5. 若所有更新成功，提交交易（Commit）
6. 若任何步驟失敗，回滾交易（Rollback）並返回錯誤訊息

驗證規則：
- menu_name：必填，長度 1-50 字元
- page_name：必填，長度 1-50 字元
- menu_no、page_no：必填，正整數
- menu_id、page_id：必填，字串格式
- dashboard_id、url、genie_id：選填

錯誤處理：
- 資料驗證失敗：返回 400 並說明具體錯誤欄位
- 資料庫操作失敗：回滾交易，返回 500 錯誤
- 交易回滾後，所有變更不會生效，保持資料庫原始狀態

**SQL 查詢語句:**

```sql
-- 開啟交易
BEGIN TRANSACTION;

-- 更新選單資料（MERGE 或 INSERT/UPDATE）
MERGE INTO dev_temp.data_engineer.gdp_menu_data AS target
USING (SELECT :menu_id AS menu_id, :menu_name AS menu_name, :menu_no AS menu_no) AS source
ON target.menu_id = source.menu_id
WHEN MATCHED THEN
  UPDATE SET 
    menu_name = source.menu_name,
    menu_no = source.menu_no
WHEN NOT MATCHED THEN
  INSERT (menu_id, menu_name, menu_no)
  VALUES (source.menu_id, source.menu_name, source.menu_no);

-- 更新頁面資料（MERGE 或 INSERT/UPDATE）
MERGE INTO dev_temp.data_engineer.gdp_page_data AS target
USING (
  SELECT 
    :page_id AS page_id,
    :page_name AS page_name,
    :page_no AS page_no,
    :menu_id AS menu_id,
    :dashboard_id AS dashboard_id,
    :url AS url,
    :genie_id AS genie_id
) AS source
ON target.page_id = source.page_id
WHEN MATCHED THEN
  UPDATE SET 
    page_name = source.page_name,
    page_no = source.page_no,
    menu_id = source.menu_id,
    dashboard_id = source.dashboard_id,
    url = source.url,
    genie_id = source.genie_id
WHEN NOT MATCHED THEN
  INSERT (page_id, page_name, page_no, menu_id, dashboard_id, url, genie_id)
  VALUES (source.page_id, source.page_name, source.page_no, source.menu_id, source.dashboard_id, source.url, source.genie_id);

-- 提交交易
COMMIT;

-- 若發生錯誤，回滾交易
ROLLBACK;
```
