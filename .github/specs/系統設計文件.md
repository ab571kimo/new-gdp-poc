# 系統設計文件 GDP POC 系統
- 用於Databricks apps 
- 沒提到的技術不自己想像 

# 開發規範 

本系統為一個 React (TypeScript) 前端 + FastAPI 後端的專案。
- 目標部署環境包含：本機開發與 Databricks Apps（使用 `app.yaml` 進行執行命令宣告）。
- 遵循 RESTful API 設計原則
- 採用前後端分離架構
- 前端使用 React Router 進行路由管理
- 後端使用 FastAPI 路由進行 API 端點管理
- 所有 API 路徑統一以 `/api/` 開頭

# 使用技術 

**Language/Runtime**:
- Backend: Python 3.11
- Frontend: TypeScript 5.x + React 18.2

**Primary Dependencies**:
- Backend: FastAPI 0.109.0, Uvicorn 0.27.0, python-multipart 0.0.9, aiofiles 23.2.1
- Frontend: React, React-DOM, Vite 5.x, @vitejs/plugin-react

# 使用套件、版本 

## backend
- backend套件需同步更新至/requirements.txt

| 套件 | 版本 | 用途 |
|------|------|------|
| fastapi | 0.109.0 | API 框架 |
| uvicorn | 0.27.0 | ASGI Server |
| python-multipart | 0.0.9 | 處理表單/檔案上傳（未來擴充） |
| aiofiles | 23.2.1 | 非同步檔案存取 |

## frontend

| 套件 | 版本 | 用途 |
|------|------|------|
| react | ^18.2.0 | UI Library |
| react-dom | ^18.2.0 | DOM Render |
| vite | ^5.0.0 | 打包/開發伺服器 |
| @vitejs/plugin-react | ^4.2.0 | React 插件 |
| typescript | ^5.0.0 | 型別系統 |

# 程式產出位置
- 產出位置參考下方
```
├── .github/
├── gdp-poc/
│   ├── backend/
│   ├── frontend/
│   ├── app.yaml
│   ├── package.json
│   ├── requirements.txt
│   ├── tsconfig.json
│   └── .databricks/
│   	└── .gitignore
├── .gitignore
└── run.sh
```

# 設定檔
- 前後端依照此設定檔開發及擴充
```
./app.yaml
./package.json 
./requirements.txt
./tsconfig.json
./vite.config.ts
```

## ./app.yaml
```yaml
command: ["uvicorn", "backend.main:app"]
```

## .gitignore 設定
```
node_modules/
```

## run.sh
```bash
python.exe -m uvicorn gdp-poc.backend.main:app --reload --host 0.0.0.0 --port 8000 
```

## 執行專案
```bash
# 1. 安裝套件
npm install
pip install -r requirements.txt

# 2. 建置前端
npm run build

# 3. 啟動後端
uvicorn backend.main:app --host 0.0.0.0 --port 8000
```

# 路由處理邏輯
/api/* → 後端 API 處理
其他路徑 → 返回 index.html（SPA 路由）
啟動設定 (從 app.yaml)
Databricks Apps 環境不需要CORS middleware

## Catch-all 路由處理器
```
@app.get("/{full_path:path}")
async def serve_react(full_path: str):
```
運作邏輯：

## 靜態資源檔案（如 .js, .css, .png 等）
```
if "." in full_path:  # 判斷是否有副檔名
    file_path = os.path.join(static_dir, full_path)
    if os.path.exists(file_path):
        return FileResponse(file_path)  # 回傳檔案
```
## React SPA 路由（如 /dashboard, /users 等）
```
index_html = os.path.join(static_dir, "index.html")
if os.path.exists(index_html):
    return FileResponse(index_html)  # 回傳 index.html
```
任何不是靜態檔案的路徑，都回傳 index.html
讓 React Router 在前端處理路由邏輯

## 錯誤處理
```
raise HTTPException(status_code=404, detail="...")
```
如果連 index.html 都不存在，表示前端未編譯，回傳 404 錯誤

# 目錄結構 

存放路徑於 ./gdp-poc/

## backend
```
backend/
├── __init__.py
├── main.py
└── api/
    └── menu/
        ├── __init__.py
        └── menu.py
```

## frontend
```
frontend/
├── index.html             (Vite 入口)
└── src/
    ├── components/   (站台共用的css,tsx,ts放這)
    |   ├── Header/
    |   └── Sidebar/  
    ├── GDP_UI_01/         
    └── GDP_UI_02/   (頁面專用的css,tsx,ts放這)
        ├── GDP_UI_02.css 
        ├── GDP_UI_02.tsx (放 UI 元件、JSX、渲染邏輯)
        └── GDP_UI_02.ts  (放邏輯、函式、API 呼叫、型別定義)   
```

# Databricks 資料庫連線方式

```python
app.yaml 環境變數

env:
- name: WAREHOUSE_TOKEN
  value: ***
  
- name: WAREHOUSE_HTTP_PATH
  value: ***
 

程式碼
    try:
        # Databricks 連線設定 (從環境變數取得)
        server_hostname = os.getenv("DATABRICKS_HOST")
        http_path = os.getenv("WAREHOUSE_HTTP_PATH")
        access_token = os.getenv("WAREHOUSE_TOKEN")
        
        with sql.connect(
            server_hostname=server_hostname,
            http_path=http_path,
            access_token=access_token
        ) as connection:
            with connection.cursor() as cursor:
                cursor.execute("SQL CODE")
                raw_results = cursor.fetchall()
                users = {row[0] for row in raw_results if row[0] and row[0].strip()}
                return users
                
    except Exception as e:
        query_time = time.time() - start_time
        logger.error(f"❌ 資料庫連線失敗 (耗時: {query_time:.2f}秒): {e}")
        return {}
```

# Databricks 取得scope方式
```python
dbutils.secrets.get(scope="你的scope名稱", key="你的key名稱")
```
